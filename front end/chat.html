<!DOCTYPE html>   
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Learnhub</title>
    <link rel="stylesheet" href="chatstyle.css">
</head>
<body>
    <div class="chat-container">
        <div id="userInfo" style="display: none;">
            <p><strong>Tipo de Usuario:</strong> <span id="loggedInUserType"></span></p>
            <p><strong>ID de Usuario:</strong> <span id="loggedInUserId"></span></p>
        </div>
        <div class="chat-list" id="chatList">
            <h3>Chats</h3>
            <div id="errorMessage" style="color: red;"></div>
        </div>
        <div class="chat-box">
            <div class="message-list" id="messageList"></div>
            <form id="messageForm">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje" required>
                <button type="submit">Enviar</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js';

        const socket = io("http://localhost:3001", { autoConnect: false, reconnection: true });

        const chatList = document.getElementById('chatList');
        const messageList = document.getElementById('messageList');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const errorMessage = document.getElementById('errorMessage');
        const userInfo = document.getElementById('userInfo');
        const loggedInUserType = document.getElementById('loggedInUserType');
        const loggedInUserId = document.getElementById('loggedInUserId');

        const tipoUsuario = localStorage.getItem('tipoUsuario');
        const userId = localStorage.getItem('userId');
        const urlParams = new URLSearchParams(window.location.search);
        const idprof = urlParams.get('id');

        if (tipoUsuario && userId && idprof) {
            loadChatsForUser(tipoUsuario, userId);
            loadMessagesForChat(userId, idprof);
            socket.connect();
        } else {
            alert("No se encontraron datos de usuario o profesor. Por favor, inicia sesión.");
        }

        socket.on("previousMessages", (messages) => {
            messageList.innerHTML = '';
            messages.forEach(msg => {
                addMessage(msg);
            });
        });

        socket.on("chat message", (message) => {
            addMessage(message);
        });

        messageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const message = {
                content: messageInput.value,
                timestamp: new Date().toISOString(),
                idprof: idprof,
                idalumno: userId,
                room: `${Math.min(userId, idprof)}-${Math.max(userId, idprof)}`,
                sender: tipoUsuario
            };
            socket.emit("chat message", message);
            addMessage(message);
            messageInput.value = '';
        });

        function addMessage(message) {
            const msgElement = document.createElement('div');
            msgElement.classList.add('message');
            msgElement.innerHTML = `
                <strong>${message.sender}</strong>: ${message.content}
                <button onclick="deleteMessage(${message.idprof}, ${message.idalumno}, '${message.timestamp}')">Eliminar</button>
            `;
            messageList.appendChild(msgElement);
        }

        function loadChatsForUser(tipoUsuario, userId) {
            fetch(`http://localhost:3001/api/chats?tipoUsuario=${tipoUsuario}&userId=${userId}`)
                .then(response => response.json())
                .then(chats => {
                    chatList.innerHTML = '<h3>Chats</h3>';
                    if (chats.length === 0) {
                        chatList.innerHTML += '<p>No tienes chats disponibles.</p>';
                    } else {
                        chats.forEach(chat => {
                            const chatBox = document.createElement('div');
                            chatBox.classList.add('chat-item');
                            chatBox.innerHTML = `
                                <p><strong>${chat.otherUserName}</strong></p>
                                <p>Último mensaje: ${chat.lastMessage}</p>
                                <button class="delete-chat" onclick="deleteChat(${chat.idprof}, ${chat.idalumno})">Eliminar</button>
                            `;
                            chatList.appendChild(chatBox);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error al cargar chats:", error);
                    errorMessage.textContent = "Error al cargar la lista de chats.";
                });
        }

        function loadMessagesForChat(userId, idprof) {
            const room = `${Math.min(userId, idprof)}-${Math.max(userId, idprof)}`;

            fetch(`http://localhost:3001/api/messages?room=${room}`)
                .then(response => response.json())
                .then(messages => {
                    messageList.innerHTML = '';
                    messages.forEach(msg => {
                        addMessage(msg);
                    });
                })
                .catch(error => {
                    console.error("Error al cargar los mensajes:", error);
                    alert("Error al cargar los mensajes.");
                });
        }

        async function deleteMessage(idprof, idalumno, timestamp) {
            try {
                const response = await fetch("http://localhost:3001/api/messages", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ idprof, idalumno, timestamp })
                });
                
                if (response.ok) {
                    alert("Mensaje eliminado.");
                    loadMessagesForChat(userId, idprof);
                } else {
                    alert("Error al eliminar el mensaje.");
                }
            } catch (error) {
                console.error("Error al eliminar mensaje:", error);
                alert("Error de red al eliminar el mensaje.");
            }
        }

        async function deleteChat(idprof, idalumno) {
            try {
                const response = await fetch("http://localhost:3001/api/chats", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ idprof, idalumno })
                });

                if (response.ok) {
                    alert("Chat eliminado correctamente.");
                    loadChatsForUser(tipoUsuario, userId);
                } else {
                    alert("Error al eliminar el chat.");
                }
            } catch (error) {
                console.error("Error de red al intentar eliminar el chat:", error);
            }
        }

        // Función para notificar al profesor de un nuevo chat
        socket.on("newChat", (chatInfo) => {
            if (tipoUsuario === 'profesor' && chatInfo.idprof === parseInt(userId)) {
                loadChatsForUser(tipoUsuario, userId);
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Learnhub</title>
    <link rel="stylesheet" href="chatstyle.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-list" id="chatList">
            <h3>Chats</h3>
            <div id="errorMessage" style="color: red;"></div>
        </div>
        <div class="chat-box">
            <div class="message-list" id="messageList"></div>
            <form id="messageForm">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje" required>
                <button type="submit">Enviar</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js';

        const socket = io("http://localhost:3001", { autoConnect: false, reconnection: true });

        const chatList = document.getElementById('chatList');
        const messageList = document.getElementById('messageList');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const errorMessage = document.getElementById('errorMessage');

        // Función para obtener el ID del profesor desde el localStorage
        function getIdProf() {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const userId = localStorage.getItem('userId');
            
            if (tipoUsuario === 'profesor') {
                // Si el usuario es un profesor, usamos el userId como idprof
                return userId;
            }
            return null;
        }

        // Obtener valores de tipo de usuario e ID desde el localStorage
        const tipoUsuario = localStorage.getItem('tipoUsuario');
        const userId = localStorage.getItem('userId');
        const idprof = getIdProf(); // Usamos la función para obtener idprof cuando sea necesario

        let currentRoom = null;

        // Debug: Mostrar valores en consola para verificación
        console.log("tipoUsuario:", tipoUsuario);
        console.log("userId:", userId);
        console.log("idprof:", idprof);

        if (tipoUsuario && userId && idprof) {
            loadChatsForUser(tipoUsuario, userId);
            socket.connect();
        } else {
            alert("No se encontraron datos de usuario o profesor. Por favor, inicia sesión.");
        }

        socket.on("chat message", (message) => {
            if (message.room === currentRoom) {
                addMessage(message);
            }
        });

        messageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const message = {
                content: messageInput.value,
                timestamp: new Date().toISOString(),
                idprof: tipoUsuario === 'profesor' ? userId : idprof, // Asegura que el profesor envíe con su propio ID
                idalumno: tipoUsuario === 'alumno' ? userId : null, // Solo si el usuario es alumno
                room: currentRoom,
                sender: tipoUsuario
            };
            socket.emit("chat message", message);
            addMessage(message);
            messageInput.value = '';
        });

        function addMessage(message) {
            const msgElement = document.createElement('div');
            msgElement.classList.add('message');
            msgElement.innerHTML = `<strong>${message.sender}</strong>: ${message.content}`;
            messageList.appendChild(msgElement);
            messageList.scrollTop = messageList.scrollHeight; // Auto-scroll al final
        }

        function loadChatsForUser(tipoUsuario, userId) {
            fetch(`http://localhost:3001/api/chats?tipoUsuario=${tipoUsuario}&userId=${userId}`)
                .then(response => response.json())
                .then(chats => {
                    chatList.innerHTML = '<h3>Chats</h3>';
                    if (Array.isArray(chats)) {
                        if (chats.length === 0) {
                            chatList.innerHTML += '<p>No tienes chats disponibles.</p>';
                        } else {
                            chats.forEach(chat => {
                                const chatBox = document.createElement('div');
                                chatBox.classList.add('chat-item');
                                chatBox.innerHTML = `<p><strong>${chat.otherUserName || "Usuario Desconocido"}</strong></p>`;
                                chatBox.addEventListener('click', () => {
                                    currentRoom = `${Math.min(chat.userId, chat.otherUserId)}-${Math.max(chat.userId, chat.otherUserId)}`;
                                    loadMessagesForChat(currentRoom);
                                });
                                chatList.appendChild(chatBox);
                            });
                        }
                    } else {
                        errorMessage.textContent = "Error: La respuesta del servidor no es un arreglo.";
                    }
                })
                .catch(error => {
                    console.error("Error al cargar chats:", error);
                    errorMessage.textContent = "Error al cargar la lista de chats.";
                });
        }

        function loadMessagesForChat(room) {
            const roomParts = room.split('-').map(Number);
            if (isNaN(roomParts[0]) || isNaN(roomParts[1])) {
                console.error("Invalid room ID:", room);
                return;  // Stop if room ID is invalid
            }

            fetch(`http://localhost:3001/api/messages?room=${room}`)
                .then(response => response.json())
                .then(messages => {
                    messageList.innerHTML = '';
                    if (Array.isArray(messages)) {
                        messages.forEach(msg => {
                            addMessage(msg);
                        });
                    } else {
                        console.error("Error: messages is not an array.");
                    }
                })
                .catch(error => {
                    console.error("Error al cargar los mensajes:", error);
                    alert("Error al cargar los mensajes.");
                });
        }

        socket.on("newChat", (chatInfo) => {    
            if (tipoUsuario === 'profesor' && chatInfo.idprof === parseInt(userId)) {
                loadChatsForUser(tipoUsuario, userId);
            }
        });
    </script>
</body>
</html>

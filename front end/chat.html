<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Learnhub</title>
    <link rel="stylesheet" href="chatstyle.css">
</head>
<body>
    <div class="chat-container">
        <!-- Contenedor de inicio de sesión -->
        <div class="login-container">
            <select id="tipoUsuario">
                <option value="alumno">Alumno</option>
                <option value="profesor">Profesor</option>
            </select>
            <input type="number" id="userIdInput" placeholder="Tu ID de usuario" required>
            <input type="number" id="otherUserIdInput" placeholder="ID del otro usuario" required>
            <button id="loginButton">Iniciar sesión</button>
        </div>
        
        <!-- Lista de chats con el botón para eliminar -->
        <div class="chat-list" id="chatList">
            <h3>Chats</h3>
            <div id="errorMessage" style="color: red;"></div>
            <div class="chat-item">
                <span>Chat con: <span id="chatWith">Nombre del usuario</span></span>
                <button onclick="deleteChat(idprof, idalumno)">Eliminar Chat</button>
            </div>
        </div>

        <!-- Caja de chat y formulario de mensaje -->
        <div class="chat-box">
            <div class="message-list" id="messageList"></div>
            <form id="messageForm">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje" required>
                <button type="submit">Enviar</button>
            </form>
        </div>
    </div>

    <script type="module"> 
        import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js';
    
        const socket = io("http://localhost:3001", {
            autoConnect: false,
            reconnection: true
        });
        const chatList = document.getElementById('chatList');
        const messageList = document.getElementById('messageList');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const errorMessage = document.getElementById('errorMessage');
    
        const loginButton = document.getElementById('loginButton');
        const tipoUsuarioSelect = document.getElementById('tipoUsuario');
        const userIdInput = document.getElementById('userIdInput');
        const otherUserIdInput = document.getElementById('otherUserIdInput');
    
        let currentChat = null;
        let loadedMessages = new Set();
    
        loginButton.addEventListener('click', () => {
            const tipoUsuario = tipoUsuarioSelect.value;
            const userId = userIdInput.value;
            const otherUserId = otherUserIdInput.value;
    
            if (!userId || !otherUserId) {
                errorMessage.textContent = "Por favor, ingresa tu ID y el ID del otro usuario.";
                return;
            }
    
            localStorage.setItem('tipoUsuario', tipoUsuario);
            localStorage.setItem('userId', userId);
            localStorage.setItem('otherUserId', otherUserId);
    
            const room = `${Math.min(userId, otherUserId)}-${Math.max(userId, otherUserId)}`;
            socket.emit('joinRoom', room);
            
            loadChatsForUser(tipoUsuario, userId);
            socket.connect();
        });
    
        window.addEventListener('load', () => {
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const userId = localStorage.getItem('userId');
            const otherUserId = localStorage.getItem('otherUserId');
    
            if (tipoUsuario && userId && otherUserId) {
                const room = `${Math.min(userId, otherUserId)}-${Math.max(userId, otherUserId)}`;
                socket.emit('joinRoom', room);
                loadChatsForUser(tipoUsuario, userId);
                loadChat(userId, otherUserId);
                socket.connect();
            }
        });
    
        socket.on('connect', () => {
            console.log("Conectado al servidor de chat.");
        });
    
        socket.on("previousMessages", (messages) => {
            messages.forEach(message => {
                displayMessage(message);
            });
        });
    
        function loadChatsForUser(tipoUsuario, userId) {
            fetch(`http://localhost:3001/api/chats?tipoUsuario=${tipoUsuario}&userId=${userId}`)
                .then(response => response.json())
                .then(chats => {
                    chatList.innerHTML = '<h3>Chats</h3>';
                    chats.forEach(chat => addChatBox(chat));
                })
                .catch(error => {
                    console.error("Error al cargar chats:", error);
                    errorMessage.textContent = "Error al cargar la lista de chats.";
                });
        }
    
        function addChatBox(chat) {
            const chatItem = document.createElement('div');
            chatItem.textContent = `Chat con: ${chat.otherUserName}`;
            chatItem.classList.add('chat-item');
            chatItem.addEventListener('click', () => {
                currentChat = chat;
                loadChat(localStorage.getItem('userId'), chat.idprof, chat.idalumno);
            });
            chatList.appendChild(chatItem);
        }
    
        function loadChat(idprof, idalumno) {
            fetch(`http://localhost:3001/api/messages?idprof=${idprof}&idalumno=${idalumno}`)
                .then(response => response.json())
                .then(messages => {
                    messageList.innerHTML = '';
                    loadedMessages.clear();
                    messages.forEach(message => displayMessage(message));
                    messageList.scrollTop = messageList.scrollHeight;
                    socket.emit('requestPreviousMessages', { idprof, idalumno });
                })
                .catch(error => {
                    console.error("Error al cargar mensajes:", error);
                    errorMessage.textContent = "Error al cargar mensajes.";
                });
        }
    
        function displayMessage(message) {
            if (loadedMessages.has(message.id)) return;
            loadedMessages.add(message.id);
    
            const messageItem = document.createElement('div');
            const isSentByCurrentUser = message.sender === localStorage.getItem('tipoUsuario');
            const senderClass = isSentByCurrentUser ? 'sent' : 'received';
            messageItem.textContent = `${message.content} - ${new Date(message.timestamp).toLocaleString()}`;
            messageItem.classList.add('message-item', senderClass);
            messageList.appendChild(messageItem);
            messageList.scrollTop = messageList.scrollHeight;
        }
    
        messageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const tipoUsuario = localStorage.getItem('tipoUsuario');
            const userId = localStorage.getItem('userId');
            const otherUserId = localStorage.getItem('otherUserId');
            const room = `${Math.min(userId, otherUserId)}-${Math.max(userId, otherUserId)}`;
    
            if (messageInput.value) {
                const message = {
                    idprof: tipoUsuario === 'profesor' ? userId : otherUserId,
                    idalumno: tipoUsuario === 'alumno' ? userId : otherUserId,
                    content: messageInput.value,
                    room: room
                };
    
                socket.emit('chat message', message);
    
                const messageItem = document.createElement('div');
                messageItem.textContent = `${message.content} - ${new Date().toLocaleString()}`;
                messageItem.classList.add('message-item', 'sent');
                messageList.appendChild(messageItem);
                messageList.scrollTop = messageList.scrollHeight;
    
                messageInput.value = '';
            } else {
                console.log("No hay mensaje para enviar.");
            }
        });
    
        socket.on('chat message', (message) => {
            const room = `${Math.min(message.idprof, message.idalumno)}-${Math.max(message.idprof, message.idalumno)}`;
            if (currentChat && message.room === room) {
                displayMessage(message);
            }
        });

        async function deleteChat(idprof, idalumno) {
  try {
    const response = await fetch("http://localhost:3001/api/chats", {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ idprof, idalumno })
    });

    if (response.ok) {
      alert("Chat eliminado correctamente.");
    } else {
      const errorData = await response.json();
      console.error("Error al eliminar el chat:", errorData.error);
      alert("Error al eliminar el chat.");
    }
  } catch (error) {
    console.error("Error de red al eliminar el chat:", error);
    alert("Error de red al intentar eliminar el chat.");
  }
}
    </script>
</body>
</html>
        
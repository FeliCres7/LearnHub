<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Learnhub</title>
    <link rel="stylesheet" href="chatstyle.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-list" id="chatList">
            <h3>Chats</h3>
            <div id="errorMessage" style="color: red;"></div>
        </div>

        <div class="chat-box">
            <div class="message-list" id="messageList"></div>
            <form id="messageForm">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje" required>
                <button type="submit">Enviar</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { io } from 'https://cdn.socket.io/4.3.2/socket.io.esm.min.js';

        const socket = io("https://learn-hub-eta.vercel.app");
        const chatList = document.getElementById('chatList');
        const messageList = document.getElementById('messageList');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const errorMessage = document.getElementById('errorMessage');

        let currentChat = null;

       
        // Recuperar tipo de usuario y ID desde localStorage
        const tipoUsuario = localStorage.getItem('tipoUsuario');
        const userId = localStorage.getItem('userId');

        console.log("Tipo de Usuario:", tipoUsuario);
        console.log("User ID:", userId);

        fetch(`https://learn-hub-eta.vercel.app/api/chats?userId=${userId}&tipoUsuario=${tipoUsuario}`)
            .then(response => {
              console.log("Respuesta de la API:", response); 
                if (!response.ok) {
                    throw new Error('Error en la red: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                console.log(data);
                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.textContent = chat.nombre;
                        chatItem.classList.add('chat-item');
                        chatItem.addEventListener('click', () => {
                            loadChat(chat.idprof, chat.idalumno);
                        });
                        chatList.appendChild(chatItem);
                    });
                } else {
                    errorMessage.textContent = "No se encontraron chats disponibles.";
                }
            })
            .catch(error => {
                console.error("Error al cargar la lista de chats:", error);
                errorMessage.textContent = "Error al cargar la lista de chats. Intente de nuevo más tarde.";
            });

        // Función para cargar el historial de un chat
        function loadChat(idprof, idalumno) {
            currentChat = { idprof, idalumno };
            fetch(`https://learn-hub-eta.vercel.app/api/messages?idprof=${idprof}&idalumno=${idalumno}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la red: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(messages => {
                    messageList.innerHTML = '';
                    messages.forEach(message => {
                        const messageItem = document.createElement('div');
                        messageItem.textContent = `${message.content} - ${new Date(message.timestamp).toLocaleString()}`;
                        messageItem.classList.add('message-item', message.sender === 'me' ? 'sent' : 'received');
                        messageList.appendChild(messageItem);
                    });
                    messageList.scrollTop = messageList.scrollHeight; // Scroll al final
                })
                .catch(error => {
                    console.error("Error al cargar mensajes:", error);
                    errorMessage.textContent = "Error al cargar mensajes. Intente de nuevo más tarde.";
                });
        }

        // Enviar un mensaje
        messageForm.addEventListener('submit', (event) => {
            event.preventDefault();
            if (messageInput.value && currentChat) {
                const message = {
                    idprof: currentChat.idprof,
                    idalumno: currentChat.idalumno,
                    content: messageInput.value
                };
                socket.emit('chat message', message);

                // Mostrar el mensaje inmediatamente en la interfaz
                const messageItem = document.createElement('div');
                messageItem.textContent = `${message.content} - ${new Date().toLocaleString()}`;
                messageItem.classList.add('message-item', 'sent');
                messageList.appendChild(messageItem);
                messageList.scrollTop = messageList.scrollHeight; // Scroll al final

                messageInput.value = ''; // Limpiar el campo de entrada
            }
        });

        // Escuchar mensajes entrantes
        socket.on('chat message', (message) => {
            if (message.idprof === currentChat.idprof && message.idalumno === currentChat.idalumno) {
                const messageItem = document.createElement('div');
                messageItem.textContent = `${message.content} - ${new Date(message.timestamp).toLocaleString()}`;
                messageItem.classList.add('message-item', 'received');
                messageList.appendChild(messageItem);
                messageList.scrollTop = messageList.scrollHeight; // Scroll al final
            }
        });
    </script>
</body>
</html>

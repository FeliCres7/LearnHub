<!DOCTYPE html>
<html lang="es">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Calendario</title>
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="stylish.css">
    <link rel="icon" href="Images html/logo pestaña.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
</head>

<body>
    <header class="header">
        <!-- Header Content -->
    </header>
    <script src="script.js"></script>
    <main class="mainfondobasico">
        <div class="Proximasclases">
            <h1>Próximas Clases</h1>
            <!-- Las reservas se agregarán aquí dinámicamente -->
        </div>
        <div id="calendar"></div>
    </main>

    <script>
function getProfesorIdFromToken() {
    const token = localStorage.getItem('token'); // Asegúrate de tener el token en localStorage
    console.log('Token recibido:', token); // Log para ver el token recibido
    if (!token) {
        console.error('Token no encontrado');
        return null;
    }

    const tokenParts = token.split('.');
    console.log('Token dividido:', tokenParts); // Log para ver cómo está dividido el token
    if (tokenParts.length !== 3) {
        console.error('Token no tiene el formato adecuado');
        return null;
    }

    try {
        const decodedToken = JSON.parse(atob(tokenParts[1])); // Decodificar el token
        console.log('Decoded Token:', decodedToken); // Muestra el token decodificado
        return decodedToken.id; // Asegúrate de que el campo correcto esté aquí
    } catch (error) {
        console.error('Error al decodificar el token:', error);
        return null;
    }
}

async function getReservasByProfesor(idprof) {
    console.log('Obteniendo reservas para el profesor con ID:', idprof); // Log para ver el ID del profesor
    try {
        const response = await fetch(`https://learn-hub-eta.vercel.app/reservaciones/IDprof/${idprof}`);
        console.log('Respuesta de la API de reservas:', response); // Log para ver la respuesta de la API
        if (response.ok) {
            const data = await response.json();
            console.log('Datos de las reservas:', data); // Log para ver toda la estructura de los datos
            // Verificar la estructura exacta y usar la propiedad correcta
            return data.reservas || []; // Asegúrate de acceder a "reservas" o al nombre correcto
        } else {
            console.error('Error al obtener las reservas del profesor:', response.statusText);
            alert('Hubo un error al obtener las reservas.');
            return [];
        }
    } catch (error) {
        console.error('Error en la solicitud fetch:', error);
        alert('Hubo un error con la conexión.');
        return [];
    }
}

document.addEventListener('DOMContentLoaded', async function () {
    const idprof = getProfesorIdFromToken(); // Obtener el ID del profesor desde el token

    if (!idprof) {
        alert('No se pudo obtener el ID del profesor.');
        return;
    }

    const reservas = await getReservasByProfesor(idprof);
    const proximasClasesDiv = document.querySelector('.Proximasclases');

    // Mostrar las reservas en "Próximas Clases"
    if (reservas && reservas.length > 0) {
        reservas.forEach(reserva => {
            const fecha = new Date(reserva.fechaInicio);
            const dia = fecha.toLocaleString('es-ES', { weekday: 'long' });
            const fechaFormateada = fecha.toLocaleDateString('es-ES');
            const hora = new Date(reserva.fechaInicio).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

            const claseElement = document.createElement('p');
            claseElement.innerHTML = `${dia} ${fechaFormateada}<br>Clase con ${reserva.alumnoNombre}<br>Hora: ${hora}`;
            proximasClasesDiv.appendChild(claseElement);
        });
    }

    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events: async function (fetchInfo, successCallback, failureCallback) {
            try {
                const eventos = reservas.map(reserva => ({
                    title: `Clase con: ${reserva.alumnoNombre}`,  // Muestra el nombre del alumno
                    start: reserva.fechaInicio,
                    end: reserva.fechaFin,
                    extendedProps: {
                        alumnoNombre: reserva.alumnoNombre,  // Nombre del alumno
                        hora: reserva.hora  // Hora de la clase
                    }
                }));
                successCallback(eventos);
            } catch (error) {
                console.error('Error al cargar los eventos:', error);
                failureCallback(error);
            }
        },
        eventContent: function (arg) {
            const alumnoNombre = arg.event.extendedProps.alumnoNombre;
            const hora = arg.event.extendedProps.hora;
            const divEl = document.createElement('div');
            divEl.classList.add('reserva-evento');
            divEl.innerHTML = `
                <strong>Clase con: ${alumnoNombre}</strong><br>
                <span>Hora: ${hora}</span>
            `;
            return { domNodes: [divEl] };
        }
    });

    calendar.render();
});
    </script>

    <style>
        .reserva-evento {
            background-color: #f0f0f0;
            padding: 5px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #333;
        }
    </style>
</body>

</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio</title>
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="shortcut icon" href="Images html/logo pestaña.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <header class="header">
        <img class="logoarriba" src="Images html/LOGOLH.png" alt="Learn Hub">
        <div class="search">
            <input type="search" name="Buscar" id="búsqueda" placeholder="Buscar">
            <button id="header-search" class="buttonsearch"><i class="fas fa-search"></i></button>
        </div>

        <nav class="navbar">
            <ul>
                <li class="boton-inicio"><button class="inicio" onclick="window.location.href='home.html'"><img
                            src="Images html/logo inicio.png" alt=""></button><a href="home.html">Inicio</a></li>
                <li class="boton-perfil-alumno"><button onclick="window.location.href='perfil.html'"><img
                            src="Images html/logo perfil alumno.png" alt=""></button><a href="perfil.html">Perfil</a>
                </li>
                <li class="boton-mis-profesores"><button onclick="window.location.href='misprofesores.html'"><img
                            src="Images html/logo mis profesores.png" alt=""></button><a href="misprofesores.html">Mis
                        profesores</a></li>
                <li class="boton-calendario"><button onclick="window.location.href='calendario.html'"><img
                            src="Images html/logo calendario.png" alt=""></button><a
                        href="calendario.html">Calendario</a></li>
                <li class="boton-configuracion"><button onclick="window.location.href='configuracion.html'"><img
                            src="Images html/logo configuracion.png" alt=""></button><a
                        href="configuracion.html">Configuración</a></li>
            </ul>
        </nav>
        <button id="menubutton"><img src="Images html/menubutton.png" alt="MENU"></button>
        <nav class="menu" id="menu">
            <ul>
                <li><a href="home.html">Inicio</a></li>
                <li><a href="perfil.html">Perfil</a></li>
                <li><a href="misprofesores.html">Mis profesores</a></li>
                <li><a href="calendario.html">Calendario</a></li>
                <li><a href="configuracion.html">Configuración</a></li>
            </ul>
        </nav>
    </header>

    <main class="main-home">
        <aside class="aside-izq-home">
            <img class="foto-perfil" id="foto-perfil" src="Images html/icon perfil.png" alt="">
            <p id="nombre-apellido" class="big">Nombre y apellido</p>
            <p id="pais" class="small">País</p>
        </aside>
        <article class="article-home">
            <div class="top-article-home">
                <p>Valora tu clase con </p>
                <p class="bold" id="nombre-alumno"> Nombre y apellido</p>
            </div>
            <div class="fotoyvaloracion-article-home">
                <img src="Images html/icon perfil.png" alt="">
                <div>
                    <p>Coso para valorar</p>
                    <button class="enviar-valoracion">Enviar valoración</button>
                </div>
            </div>
        </article>
        <aside class="aside-der-home">
            <div class="title-aside-der-home">
                <p class="bold">Calendario</p>
            </div>
            <div id="reservaciones-lista">
                <!-- Las reservaciones se cargarán aquí -->
            </div>
        </aside>
    </main>

    <script>
    document.addEventListener("DOMContentLoaded", async () => {
        console.log("DOM cargado y script iniciado.");
    
        try {
            // Obtener el token
            const token = localStorage.getItem("token");
            console.log("Token obtenido del localStorage:", token);
    
            if (!token) {
                console.log("No se encontró un token, redirigiendo al login.");
                window.location.href = "login.html";
                return;
            }
    
            // Decodificar el token para obtener el ID del usuario
            const base64Url = token.split(".")[1];
            const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
            const jsonPayload = decodeURIComponent(
                atob(base64)
                    .split("")
                    .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
                    .join("")
            );
            const payload = JSON.parse(jsonPayload);
            const userId = payload.userId;
            console.log("Payload decodificado:", payload);
            console.log("ID de usuario obtenido:", userId);
    
            // Obtener datos del alumno
            const alumnoResponse = await fetch(`https://learn-hub-eta.vercel.app/Alumnos/${userId}`, {
                headers: {
                    Authorization: `Bearer ${token}`,
                },
            });
            console.log("Respuesta de la API Alumnos:", alumnoResponse);
    
            if (!alumnoResponse.ok) {
                console.log("Error al obtener datos del alumno, status:", alumnoResponse.status);
                throw new Error("No se pudieron obtener los datos del alumno");
            }
            const alumnoData = await alumnoResponse.json();
            console.log("Datos del alumno:", alumnoData);
    
            // Obtener datos de las reservaciones del alumno
            const IDalumno = alumnoData.id;
            console.log("ID del alumno para la API Reservaciones:", IDalumno);
    
            const reservacionesResponse = await fetch(
                `https://learn-hub-eta.vercel.app/reservaciones/IDalumno/${IDalumno}`,
                {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                }
            );
            console.log("Respuesta de la API Reservaciones:", reservacionesResponse);
    
            if (!reservacionesResponse.ok) {
                console.log("Error al obtener reservaciones, status:", reservacionesResponse.status);
                throw new Error("No se pudieron obtener las reservaciones");
            }
    
            const reservacionesData = await reservacionesResponse.json();
            console.log("Datos de las reservaciones:", reservacionesData);
    
            // Manipulación del DOM con los datos
            document.getElementById("nombre").textContent = alumnoData.nombre;
            document.getElementById("apellido").textContent = alumnoData.apellido;
            document.getElementById("reservaciones").textContent = JSON.stringify(reservacionesData);
            console.log("DOM actualizado con los datos del alumno y sus reservaciones.");
            
        } catch (error) {
            console.error("Error en el flujo del script:", error);
        }
    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Configuración</title>
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="stylish.css">
    <link rel="icon" href="Images html/logo pestaña.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
</head>

<body>
    <header class="header">
        <img class="logoarriba" src="Images html/LOGOLH.png" alt="Learn Hub">
        <div class="search">
            <input type="search" name="Buscar" id="búsqueda" placeholder="Buscar">
            <button class="buttonsearch"><i class="fas fa-search"></i></button>
        </div>
        <nav class="navbar">
            <ul>
                <li class="boton-inicio"><button class="inicio" onclick="window.location.href='home.html'"><img src="Images html/logo inicio.png" alt=""></button><a href="home.html">Inicio</a></li>
                <li class="boton-perfil-alumno"><button onclick="window.location.href='perfil.html'"><img src="Images html/logo perfil alumno.png" alt=""></button><a href="perfil.html">Perfil</a></li>
                <li class="boton-mis-profesores"><button onclick="window.location.href='misprofesores.html'"><img src="Images html/logo mis profesores.png" alt=""></button><a href="misprofesores.html">Mis profesores</a></li>
                <li class="boton-calendario"><button onclick="window.location.href='calendario.html'"><img src="Images html/logo calendario.png" alt=""></button><a href="calendario.html">Calendario</a></li>
                <li class="boton-configuracion"><button onclick="window.location.href='configuracion.html'"><img src="Images html/logo configuracion.png" alt=""></button><a href="configuracion.html">Configuración</a></li>
            </ul>
        </nav>
        <button id="menubutton"><img src="Images html/menubutton.png" alt="MENU"></button>
        <nav class="menu" id="menu">
            <ul>
                <li><a href="home.html">Inicio</a></li>
                <li><a href="perfil.html">Perfil</a></li>
                <li><a href="misprofesores.html">Mis profesores</a></li>
                <li><a href="calendario.html">Calendario</a></li>
                <li><a href="configuracion.html">Configuración</a></li>
            </ul>
        </nav>
    </header>

    <!-- Calendario de eventos -->
    <div id="calendar"></div>

    <!-- Próximas clases section -->
    <div id="Proximas clases">
        <h1>Próximas Clases</h1>
        <p>Lunes 1/10</p>
        <p>15:00-16:30</p>
        <p>Clase con Ezequiel Agradnik</p>
        <p>18:00-19:00</p>
        <p>Clase con Sergio Coppa</p>
        <p>Viernes 4/10</p>
        <p>16:00-17:00</p>
        <p>Clase con Martín Melman</p>
        <p>15:00-16:00</p>
        <p>Clase con Sergio Coppa</p>
    </div>

    <script>
        // Función para obtener las reservas de un alumno
        async function getReservasByAlumno(IDalumno) {
            try {
                const response = await fetch(`https://tu-api-url.com/reservaciones/alumno/${IDalumno}`);

                if (response.ok) {
                    const reservas = await response.json();
                    console.log('Reservas del alumno:', reservas);
                    return reservas; // Aquí puedes actualizar la interfaz con las reservas obtenidas
                } else {
                    console.error('Error al obtener las reservas del alumno:', response.statusText);
                    alert('Hubo un error al obtener las reservas.');
                }
            } catch (error) {
                console.error('Error en la solicitud fetch:', error);
                alert('Hubo un error con la conexión.');
            }
        }

        // Función para obtener las reservas de un profesor
        async function getReservasByProfesor(idprof) {
            try {
                const response = await fetch(`'https://learn-hub-eta.vercel.app/reservaciones/profesor/${idprof}`);

                if (response.ok) {
                    const reservas = await response.json();
                    console.log('Reservas del profesor:', reservas);
                    return reservas; // Aquí puedes actualizar la interfaz con las reservas obtenidas
                } else {
                    console.error('Error al obtener las reservas del profesor:', response.statusText);
                    alert('Hubo un error al obtener las reservas.');
                }
            } catch (error) {
                console.error('Error en la solicitud fetch:', error);
                alert('Hubo un error con la conexión.');
            }
        }

        // Función para crear una nueva reserva
        async function createReserva(IDalumno, idprof, dia, hora, fecha) {
            console.log("Iniciando proceso para crear una nueva reserva...");
            const data = {
                IDalumno,
                idprof,
                dia,
                hora,
                fecha
            };

            console.log("Datos de la reserva a enviar:", data);

            try {
                const apiUrl = 'https://tu-api-url.com/reservaciones'; // Asegúrate de que la URL es correcta
                console.log("URL de la API:", apiUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'POST', // Método POST para crear una nueva reserva
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                console.log("Respuesta recibida del servidor:", response);

                if (response.ok) {
                    const result = await response.json();
                    console.log('Reserva creada exitosamente:', result);

                    alert('Reserva creada exitosamente!');

                    // Aquí puedes actualizar el calendario con la nueva reserva
                    if (calendar) {
                        console.log('Añadiendo el evento al calendario...');
                        calendar.addEvent({
                            title: `Clase con ${result.reservaciones.profesor}`,
                            start: result.reservaciones.fecha,
                            description: `Clase con ${result.reservaciones.profesor}`,
                        });
                        console.log('Evento añadido al calendario.');
                    } else {
                        console.error('El calendario no está inicializado.');
                    }

                } else {
                    console.error('Error al crear la reserva:', response.statusText);
                    alert('Hubo un error al crear la reserva.');
                }
            } catch (error) {
                console.error('Error en la solicitud fetch:', error);
                alert('Hubo un error con la conexión.');
            }
        }

        // Función para capturar el evento del calendario y hacer la reserva
        function handleDateClick(info) {
            console.log("Fecha seleccionada en el calendario:", info.dateStr);
            
            const IDalumno = localStorage.getItem('userId'); // Suponiendo que el ID del alumno está en localStorage
            console.log("ID del alumno obtenido de localStorage:", IDalumno);

            if (!IDalumno) {
                console.error('No se encontró el ID del alumno en localStorage');
                alert('No se encontró el ID del alumno.');
                return;
            }

            const dia = info.dateStr; // Fecha seleccionada en el calendario
            const hora = prompt("Introduce la hora de la clase (formato HH:mm)"); // Pedir la hora de la clase
            const idprof = prompt("Introduce el ID del profesor"); // Pedir el ID del profesor

            console.log("Datos de la clase: hora:", hora, "profesor:", idprof);

            if (hora && idprof) {
                const fecha = new Date(dia).toISOString(); // Convertir la fecha a formato ISO
                console.log("Fecha convertida a formato ISO:", fecha);

                console.log("Creando la reserva...");
                createReserva(IDalumno, idprof, dia, hora, fecha); // Crear la nueva reserva
            } else {
                console.error('Faltan datos para completar la reserva');
                alert('Por favor, ingresa todos los detalles.');
            }
        }

        // Configurar el calendario
        document.addEventListener('DOMContentLoaded', function() {
            console.log("El documento está listo, configurando el calendario...");

            var calendarEl = document.getElementById('calendar');
            console.log("Elemento del calendario:", calendarEl);

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                dateClick: handleDateClick, // Captura el clic en una fecha
                events: [
                    { title: 'Evento 1', start: '2024-10-01' },
                    { title: 'Evento 2', start: '2024-10-07', end: '2024-10-10' }
                ]
            });

            console.log("Renderizando el calendario...");
            calendar.render();
        });
    </script>
</body>
</html>
